---
title: "Preprocessing MADA data"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Preprocessing MADA data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
old.opts <- getOption('digits')
options(digits = 4)
suppressWarnings(library(ldsr))  # This package
suppressWarnings(library(data.table)) # The package leverages the efficient `data.table` so we will use it in this vignette.
suppressWarnings(library(ggplot2)) # Plotting
suppressWarnings(library(geosphere)) # Plotting
```

# Introduction

In this vignette we demonstrate how to prepare the exogenous input for streamflow reconstruction. In this example, the exogeneous input is the principal components of the Monsoon Asia Drought Atlas (MADA) (Cook et al, 2010) grid points within 1200 km from stream gauge station P1. The example shown here reproduces the results by Nguyen and Galelli (2018). Further details can be found in that paper.

First, we load the necessary packages
```{r, eval = FALSE}
library(ldsr) # LDS reconstruction
library(data.table) # For efficient handling of data farmes
library(geosphere) # To calculate geodesic distances
library(ggplot2) # Plotting
```

# Data preparation

Let's read the data from NOAA database. We first read the MADA grid, which is a data frame. Each rows represents a year (1600 to 2005). The first column is year and the subsequent 534 columns represent 534 grid points.

```{r}
mada <- fread('ftp://ftp.ncdc.noaa.gov/pub/data/paleo/treering/reconstructions/asia/cook2010pdsi/jja-mada.txt')
mada[, 1:10] # View only the first 10 columns
```

Since the period before 1600 is less reliable due to a smaller number of available trees, we will only use the MADA from 1600 onwards. We also convert the data to matrix form for fast access.

```{r}
mada <- as.matrix(mada[year >= 1600, 2:535])
```

Next we read the coordinates. The data consists of two column (longitude, lattiude) and 534 rows, one for each point.
```{r}
mada.xy <- fread('ftp://ftp.ncdc.noaa.gov/pub/data/paleo/treering/reconstructions/asia/cook2010pdsi/jja-mada-xy.txt')
mada.xy
```

We can now calculate the geodesic distance between each grid point and P1 using the function `distGeo` from the `geosphere` package. This function returns distances in meters, so we'll need to convert it to kilometers.

```{r}
P1.xy <- c(99.00443, 18.78766)
dist.P1 <- distGeo(mada.xy, P1.xy) / 1000
```

Next, we filter out points that are more than 1200 km away from P1.

```{r}
sub.mada <- mada[, dist.P1 <= 1200]
str(sub.mada)
which(dist.P1 <= 1200)
```

This results in 51 points being retained. We are now ready for Principal Component Analysis.

# Principal Component Analysis

We perform principal component analysis and retain the first $N$ principal components that account for 95% of the MADA variance.

```{r}
pc.model <- summary(prcomp(sub.mada, scale. = TRUE))
pc <- data.table(pc.model$x[ , 1:which(pc.model$importance[3,] >= 0.95)[1]])
pc

```

This yields the first 12 principal components of the grid. This dataset has been included in the `ldsr` package. Let's compare the results above with the built-in data.
```{r}
P1pc
```

```{r, include=FALSE}
options(digits = old.opts)
```


# References

Nguyen, H. T. T., & Galelli, S. (2018). A linear dynamical systems approach to streamflow reconstruction reveals history of regime shifts in northern Thailand. *Water Resources Research*, **54**, 2057â€“2077. \url{https://doi.org/10.1002/2017WR022114}

Cook, E.R., Anchukaitis, K.J., Buckley, B.M., D'Arrigo, R.D., Jacoby, G.C., and Wright, W.E. (2010).  Asian monsoon failure and megadrought during the last millennium.  *Science*, **328**, 486-489.
